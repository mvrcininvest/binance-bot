events {
    worker_connections 1024;
}

http {
    upstream trading_bot {
        server trading-bot-v91:5000;
        keepalive 32;
    }

    # Nie loguj /health i /metrics (mniej szumu)
    map $request_uri $loggable {
        default              1;
        ~^/(health|metrics)$ 0;
    }

    # Rate-limit per IP (~30 req/min)
    limit_req_zone $binary_remote_addr zone=req_ip:10m rate=30r/m;

    server {
        listen 80;
        server_name _;

        access_log /var/log/nginx/access.log combined if=$loggable;
        client_max_body_size 128k;

        # üõ°Ô∏è ZABEZPIECZENIA - Blokuj boty i skanery
        if ($http_user_agent ~* (bot|crawler|scanner|nikto|sqlmap|masscan|nmap)) {
            return 444;
        }

        # üõ°Ô∏è Blokuj wra≈ºliwe pliki
        location ~ /\.(env|git|svn|htaccess|htpasswd|config|ini|log|sql|bak) {
            deny all;
            return 404;
        }
        
        # üõ°Ô∏è Blokuj PHP exploity
        location ~ /(phpinfo|info|debug|test|admin)\.php$ {
            deny all;
            return 404;
        }
        
        # üõ°Ô∏è Blokuj skanowanie katalog√≥w
        location ~ /(admin|config|env|api|portal|dev|docker|xampp|laravel|wp-admin)/ {
            deny all;
            return 404;
        }

        # Webhook TradingView ‚Äì tylko POST na dok≈Çadnej ≈õcie≈ºce
        location = /webhook/tradingview {
            limit_except POST { deny all; }
            limit_req zone=req_ip burst=20 nodelay;

            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;

            proxy_pass http://trading_bot/webhook/tradingview;
        }

        # Health check
        location /health {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_pass http://trading_bot/health;
        }

        # Metrics
        location /metrics {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_pass http://trading_bot/metrics;
        }

        # Status
        location /status {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_pass http://trading_bot/status;
        }

        # Wszystkie inne endpointy - ZABLOKOWANE
        location / {
            deny all;
            return 404;
        }
    }
}